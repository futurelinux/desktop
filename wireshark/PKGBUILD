pkgname=wireshark
pkgver=3.0.0
pkgrel=1
pkgdesc='A free network protocol analyzer for Unix/Linux and Windows'
arch=('x86_64')
license=('GPL2')
depends=('c-ares' 'libmaxminddb' 'krb5' 'libgcrypt' 'libcap' 'libpcap'
         'gnutls' 'glib2' 'lua52' 'libssh' 'libxml2' 'libnghttp2' 'snappy'
         'lz4' 'spandsp' 'sbc' 'bcg729' 'desktop-file-utils' 'qt5-multimedia' 'qt5-svg'
         'shared-mime-info' 'hicolor-icon-theme' 'xdg-utils')
makedepends=('cmake' 'ninja' 'bison' 'flex' 'qt5-tools' 'python3')
url='https://www.wireshark.org/'
install=${pkgname}.install
source=(https://www.wireshark.org/download/src/${pkgname}-${pkgver}.tar.xz
        wireshark.sysusers)
sha256sums=('bc4f30f5b2e94f3a696fef9de44673cdf402db90aac5299966da647f708f009e'
            'df07748152443c7d727bd51cd57af950c345b7141986b4f0e476cd6aa3623ac4')

prepare() {
  cd ${pkgname}-${pkgver}
  sed 's| Rev Unknown from unknown||' -i tools/make-version.pl
}

build() {
  cd ${pkgname}-${pkgver}
  cmake . -GNinja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_LIBDIR=lib \
    -DCMAKE_INSTALL_RPATH= \
    -DCMAKE_SKIP_RPATH=ON
  ninja
}

package() {
  cd ${pkgname}-${pkgver}

  DESTDIR="${pkgdir}" ninja install

  # wireshark uid group is 150
  install -Dm644 "${srcdir}/wireshark.sysusers" "${pkgdir}/usr/lib/sysusers.d/wireshark.conf"
  chgrp 150 "${pkgdir}/usr/bin/dumpcap"
  chmod 754 "${pkgdir}/usr/bin/dumpcap"

  cd ${pkgname}-${pkgver}

  install -d "${srcdir}/staging"
  DESTDIR="${srcdir}/staging" ninja install

  install -Dm755 run/wireshark -t "${pkgdir}/usr/bin"
  install -Dm644 wireshark.desktop -t "${pkgdir}/usr/share/applications"
  install -Dm644 doc/wireshark.1 -t "${pkgdir}/usr/share/man1"
  install -Dm644 wireshark.appdata.xml -t "${pkgdir}/usr/share/appdata"
  install -Dm644 wireshark-mime-package.xml "${pkgdir}/usr/share/mime/packages/wireshark.xml"
  mv "${srcdir}/staging/usr/share/icons" "${pkgdir}/usr/share/icons"
}
